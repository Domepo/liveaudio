name: Performance Tests

on:
  pull_request:
  workflow_dispatch:
    inputs:
      profile:
        description: "Profile to run"
        required: true
        default: "smoke"
        type: choice
        options:
          - smoke
          - nightly
          - weekly
  schedule:
    - cron: "0 2 * * *"
    - cron: "0 3 * * 1"

jobs:
  smoke:
    if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.profile == 'smoke')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Setup k6
        run: |
          sudo gpg -k
          sudo apt-get update
          sudo apt-get install -y gnupg ca-certificates
          sudo gpg -k
          sudo mkdir -p /etc/apt/keyrings
          curl -fsSL https://dl.k6.io/key.gpg | sudo gpg --dearmor -o /etc/apt/keyrings/k6-archive-keyring.gpg
          echo "deb [signed-by=/etc/apt/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install -y k6

      - name: Generate Prisma client + init DB
        run: npm run test:env:reset

      - name: Build API and Web
        run: |
          npm run build -w @livevoice/api
          npm run build -w @livevoice/web

      - name: Start API + Web
        run: |
          npm run start:test:api > api.log 2>&1 &
          npm run start:test:web > web.log 2>&1 &
          node ./scripts/test-env-healthcheck.cjs http://127.0.0.1:3001/health
          node ./scripts/test-env-healthcheck.cjs http://127.0.0.1:4173/login

      - name: Install Playwright Chromium
        run: npx playwright install --with-deps chromium

      - name: Run k6 smoke
        run: BASE_URL=http://127.0.0.1:3001 k6 run --summary-export k6-smoke-summary.json ./tests/load/k6/smoke.js

      - name: Run Artillery smoke
        run: API_URL=http://127.0.0.1:3001 npx artillery run ./tests/load/artillery/socket-smoke.yml --output artillery-smoke-report.json

      - name: Run WebRTC smoke
        run: WEB_BASE_URL=http://127.0.0.1:4173 npm run test:webrtc:smoke

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-smoke-artifacts
          path: |
            k6-smoke-summary.json
            artillery-smoke-report.json
            playwright-report-webrtc
            api.log
            web.log

  nightly:
    if: (github.event_name == 'schedule' && github.event.schedule == '0 2 * * *') || (github.event_name == 'workflow_dispatch' && github.event.inputs.profile == 'nightly')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Setup k6
        run: |
          sudo apt-get update
          sudo apt-get install -y gnupg ca-certificates
          sudo mkdir -p /etc/apt/keyrings
          curl -fsSL https://dl.k6.io/key.gpg | sudo gpg --dearmor -o /etc/apt/keyrings/k6-archive-keyring.gpg
          echo "deb [signed-by=/etc/apt/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install -y k6

      - name: Generate Prisma client + init DB
        run: npm run test:env:reset

      - name: Build API and Web
        run: |
          npm run build -w @livevoice/api
          npm run build -w @livevoice/web

      - name: Start API + Web
        run: |
          npm run start:test:api > api.log 2>&1 &
          npm run start:test:web > web.log 2>&1 &
          node ./scripts/test-env-healthcheck.cjs http://127.0.0.1:3001/health
          node ./scripts/test-env-healthcheck.cjs http://127.0.0.1:4173/login

      - name: Install Playwright Chromium
        run: npx playwright install --with-deps chromium

      - name: Run k6 medium
        run: BASE_URL=http://127.0.0.1:3001 k6 run --summary-export k6-medium-summary.json ./tests/load/k6/medium.js

      - name: Run Artillery smoke
        run: API_URL=http://127.0.0.1:3001 npx artillery run ./tests/load/artillery/socket-smoke.yml --output artillery-nightly-report.json

      - name: Run WebRTC smoke
        run: WEB_BASE_URL=http://127.0.0.1:4173 npm run test:webrtc:smoke

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-nightly-artifacts
          path: |
            k6-medium-summary.json
            artillery-nightly-report.json
            playwright-report-webrtc
            api.log
            web.log

  weekly:
    if: (github.event_name == 'schedule' && github.event.schedule == '0 3 * * 1') || (github.event_name == 'workflow_dispatch' && github.event.inputs.profile == 'weekly')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Setup k6
        run: |
          sudo apt-get update
          sudo apt-get install -y gnupg ca-certificates
          sudo mkdir -p /etc/apt/keyrings
          curl -fsSL https://dl.k6.io/key.gpg | sudo gpg --dearmor -o /etc/apt/keyrings/k6-archive-keyring.gpg
          echo "deb [signed-by=/etc/apt/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install -y k6

      - name: Generate Prisma client + init DB
        run: npm run test:env:reset

      - name: Build API and Web
        run: |
          npm run build -w @livevoice/api
          npm run build -w @livevoice/web

      - name: Start API + Web
        run: |
          npm run start:test:api > api.log 2>&1 &
          npm run start:test:web > web.log 2>&1 &
          node ./scripts/test-env-healthcheck.cjs http://127.0.0.1:3001/health
          node ./scripts/test-env-healthcheck.cjs http://127.0.0.1:4173/login

      - name: Install Playwright Chromium
        run: npx playwright install --with-deps chromium

      - name: Run k6 medium (weekly baseline)
        run: BASE_URL=http://127.0.0.1:3001 k6 run --summary-export k6-weekly-summary.json ./tests/load/k6/medium.js

      - name: Run Artillery smoke (weekly baseline)
        run: API_URL=http://127.0.0.1:3001 npx artillery run ./tests/load/artillery/socket-smoke.yml --output artillery-weekly-report.json

      - name: Run WebRTC smoke
        run: WEB_BASE_URL=http://127.0.0.1:4173 npm run test:webrtc:smoke

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-weekly-artifacts
          path: |
            k6-weekly-summary.json
            artillery-weekly-report.json
            playwright-report-webrtc
            api.log
            web.log
